rule apt_regin_2011_32bit_stage1 {
	meta:
		copyright = "Kaspersky Lab"
		description = "Rule to detect Regin 32 bit stage 1 loaders"
		version = "1.0"
		last_modified = "2014-11-18"
	strings:
		$key1={331015EA261D38A7}
		$key2={9145A98BA37617DE}
		$key3={EF745F23AA67243D}
		$mz="MZ"
	condition:
		($mz at 0) and any of ($key*) and filesize < 300000
}

rule apt_regin_rc5key {
	meta:
		copyright = "Kaspersky Lab"
		description = "Rule to detect Regin RC5 decryption keys"
		version = "1.0"
		last_modified = "2014-11-18"
	strings:
		$key1={73 23 1F 43 93 E1 9F 2F 99 0C 17 81 5C FF B4 01}
		$key2={10 19 53 2A 11 ED A3 74 3F C3 72 3F 9D 94 3D 78}
	condition:
		any of ($key*)
}

rule apt_regin_vfs {
	meta:
		copyright = "Kaspersky Lab"
		description = "Rule to detect Regin VFSes"
		version = "1.0"
		last_modified = "2014-11-18"
	strings:
		$a1={00 02 00 08 00 08 03 F6 D7 F3 52}
		$a2={00 10 F0 FF F0 FF 11 C7 7F E8 52}
		$a3={00 04 00 10 00 10 03 C2 D3 1C 93}
		$a4={00 04 00 10 C8 00 04 C8 93 06 D8}
	condition:
		($a1 at 0) or ($a2 at 0) or ($a3 at 0) or ($a4 at 0)
}

rule apt_regin_dispatcher_disp_dll {
	meta:
		copyright = "Kaspersky Lab"
		description = "Rule to detect Regin disp.dll dispatcher"
		version = "1.0"
		last_modified = "2014-11-18"
	strings:
		$mz="MZ"
		$string1="shit"
		$string2="disp.dll"
		$string3="255.255.255.255"
		$string4="StackWalk64"
		$string5="imagehlp.dll"
	condition:
		($mz at 0) and (all of ($string*))
}

rule apt_regin_2013_64bit_stage1 {
	meta:
		copyright = "Kaspersky Lab"
		description = "Rule to detect Regin 64 bit stage 1 loaders"
		version = "1.0"
		last_modified = "2014-11-18"
		filename1="wshnetc.dll"
		md51="bddf5afbea2d0eed77f2ad4e9a4f044d"
		filename2="wsharp.dll"
		md52="c053a0a3f1edcbbfc9b51bc640e808ce"
	strings:
		$mz="MZ"
		$a1="PRIVHEAD"
		$a2="\\\\.\\PhysicalDrive%d"
		$a3="ZwDeviceIoControlFile"
	condition:
		($mz at 0) and (all of ($a*)) and filesize < 100000
}

rule Regin_APT_KernelDriver_Generic_A {
	meta:
		description = "Generic rule for Regin APT kernel driver Malware - Symantec http://t.co/qu53359Cb2"
		author = "@Malwrsignatures - included in APT Scanner THOR"
		date = "23.11.14"
		hash1 = "187044596bc1328efa0ed636d8aa4a5c"
		hash2 = "06665b96e293b23acc80451abb413e50"
		hash3 = "d240f06e98c8d3e647cbf4d442d79475"
	strings:
		$m0 = { 4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff 00 00 b8 } 
		$m1 = { 0e 1f ba 0e 00 b4 09 cd 21 b8 01 4c cd 21 54 68 69 73 20 70 72 6f 67 72 61 6d 20 63 61 6e 6e 6f 74 20 62 65 20 72 75 6e 20 69 6e 20 44 4f 53 20 6d 6f 64 65 2e }
		
		$s0 = "atapi.sys" fullword wide
		$s1 = "disk.sys" fullword wide
		$s3 = "h.data" fullword ascii
		$s4 = "\\system32" fullword ascii
		$s5 = "\\SystemRoot" fullword ascii
		$s6 = "system" fullword ascii
		$s7 = "temp" fullword ascii
		$s8 = "windows" fullword ascii

		$x1 = "LRich6" fullword ascii
		$x2 = "KeServiceDescriptorTable" fullword ascii		
	condition:
		$m0 at 0 and $m1 and  	
		all of ($s*) and 1 of ($x*)
}

rule Regin_APT_KernelDriver_Generic_B {
	meta:
		description = "Generic rule for Regin APT kernel driver Malware - Symantec http://t.co/qu53359Cb2"
		author = "@Malwrsignatures - included in APT Scanner THOR"
		date = "23.11.14"
		hash1 = "ffb0b9b5b610191051a7bdf0806e1e47"
		hash2 = "bfbe8c3ee78750c3a520480700e440f8"
		hash3 = "b29ca4f22ae7b7b25f79c1d4a421139d"
		hash4 = "06665b96e293b23acc80451abb413e50"
		hash5 = "2c8b9d2885543d7ade3cae98225e263b"
		hash6 = "4b6b86c7fec1c574706cecedf44abded"
		hash7 = "187044596bc1328efa0ed636d8aa4a5c"
		hash8 = "d240f06e98c8d3e647cbf4d442d79475"
		hash9 = "6662c390b2bbbd291ec7987388fc75d7"
		hash10 = "1c024e599ac055312a4ab75b3950040a"
		hash11 = "ba7bb65634ce1e30c1e5415be3d1db1d"
		hash12 = "b505d65721bb2453d5039a389113b566"
		hash13 = "b269894f434657db2b15949641a67532"
	strings:
		$m0 = { 4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff 00 00 b8 } 
		$s1 = { 0e 1f ba 0e 00 b4 09 cd 21 b8 01 4c cd 21 54 68 69 73 20 70 72 6f 67 72 61 6d 20 63 61 6e 6e 6f 74 20 62 65 20 72 75 6e 20 69 6e 20 44 4f 53 20 6d 6f 64 65 2e }
		$s2 = "H.data" fullword ascii nocase
		$s3 = "INIT" fullword ascii
		$s4 = "ntoskrnl.exe" fullword ascii
		
		$v1 = "\\system32" fullword ascii
		$v2 = "\\SystemRoot" fullword ascii
		$v3 = "KeServiceDescriptorTable" fullword ascii	
		
		$w1 = "\\system32" fullword ascii
		$w2 = "\\SystemRoot" fullword ascii		
		$w3 = "LRich6" fullword ascii
		
		$x1 = "_snprintf" fullword ascii
		$x2 = "_except_handler3" fullword ascii
		
		$y1 = "mbstowcs" fullword ascii
		$y2 = "wcstombs" fullword ascii
		$y3 = "KeGetCurrentIrql" fullword ascii
		
		$z1 = "wcscpy" fullword ascii
		$z2 = "ZwCreateFile" fullword ascii
		$z3 = "ZwQueryInformationFile" fullword ascii
		$z4 = "wcslen" fullword ascii
		$z5 = "atoi" fullword ascii
	condition:
		$m0 at 0 and all of ($s*) and 
		( all of ($v*) or all of ($w*) or all of ($x*) or all of ($y*) or all of ($z*) ) 
		and filesize < 20KB
}

rule Regin_APT_KernelDriver_Generic_C {
	meta:
		description = "Generic rule for Regin APT kernel driver Malware - Symantec http://t.co/qu53359Cb2"
		author = "@Malwrsignatures - included in APT Scanner THOR"
		date = "23.11.14"
		hash1 = "e0895336617e0b45b312383814ec6783556d7635"
		hash2 = "732298fa025ed48179a3a2555b45be96f7079712"		
	strings:
		$m0 = { 4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff 00 00 b8 } 
	
		$s0 = "KeGetCurrentIrql" fullword ascii
		$s1 = "5.2.3790.0 (srv03_rtm.030324-2048)" fullword wide
		$s2 = "usbclass" fullword wide
		
		$x1 = "PADDINGXXPADDINGPADDINGXXPADDINGPADDINGXXPADDINGPADDINGXXPADDINGPADDINGXXPADDING" ascii
		$x2 = "Universal Serial Bus Class Driver" fullword wide
		$x3 = "5.2.3790.0" fullword wide
		
		$y1 = "LSA Shell" fullword wide
		$y2 = "0Richw" fullword ascii		
	condition:
		$m0 at 0 and all of ($s*) and 
		( all of ($x*) or all of ($y*) ) 
		and filesize < 20KB
}